<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XML Tree Visualization - {{ filename }}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }

        .header h1 {
            font-size: 1.5em;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .main-container {
            flex: 1;
            overflow: hidden;
            display: flex;
            background: white;
            min-height: 0; /* Important for flex scrolling */
        }

        .tree-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: auto;
            padding: 20px;
            background: #fafafa;
            min-height: 0; /* Important for flex scrolling */
        }

        /* Tree Node Styles */
        .tree-node {
            margin: 2px 0;
        }

        .tree-node-header {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            margin: 2px 0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            border: 1px solid #e0e0e0;
            user-select: none;
        }

        .tree-node-header:hover {
            background: #f0f0f0;
            border-color: #667eea;
        }

        .tree-toggle {
            cursor: pointer;
            margin-right: 10px;
            font-weight: bold;
            color: #667eea;
            min-width: 20px;
            text-align: center;
            font-size: 1.1em;
        }

        .tree-node-number {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: bold;
            margin-right: 10px;
            min-width: 50px;
            text-align: center;
        }

        .tree-node-tag {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #2C3E50;
            margin-right: 15px;
            font-size: 1em;
        }

        .tree-node-attr {
            font-size: 0.9em;
            color: #666;
            margin-left: 10px;
            display: none; /* Hidden by default - only show when node is expanded */
        }

        .tree-node-header.expanded .tree-node-attr {
            display: inline; /* Show when expanded */
        }

        .tree-node-children {
            display: none;
            margin-left: 30px;
            border-left: 2px solid #e0e0e0;
            padding-left: 15px;
        }

        .tree-node-children.expanded {
            display: block;
        }

        .tree-node-data {
            display: none;
            margin-top: 8px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            border-left: 3px solid #667eea;
            font-size: 0.9em;
            color: #555;
        }

        .tree-node-data.expanded {
            display: block;
        }

        .data-item {
            margin: 5px 0;
            padding: 5px 0;
        }

        .data-label {
            font-weight: bold;
            color: #667eea;
            margin-right: 8px;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #999;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .stats-bar {
            background: white;
            padding: 15px 30px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.85em;
            color: #666;
        }

        .controls {
            padding: 10px 30px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .controls button {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
        }

        .controls button:hover {
            background: #5568d3;
        }

        /* Scrollbar styling - Enhanced visibility */
        .tree-container::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        .tree-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 6px;
        }

        .tree-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 6px;
            border: 2px solid #f1f1f1;
        }

        .tree-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .tree-container::-webkit-scrollbar-corner {
            background: #f1f1f1;
        }

        /* Firefox scrollbar */
        .tree-container {
            scrollbar-width: thin;
            scrollbar-color: #888 #f1f1f1;
        }

        /* Image View Styles */
        .image-container {
            flex: 1;
            overflow: hidden;
            position: relative;
            background: #f8f9fa;
        }

        .image-wrapper {
            width: 100%;
            height: 100%;
            overflow: auto;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
        }

        .tree-image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            cursor: grab;
        }

        .tree-image:active {
            cursor: grabbing;
        }

        .zoom-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .zoom-btn {
            width: 45px;
            height: 45px;
            border: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 20px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .zoom-btn:hover {
            transform: scale(1.1);
        }

        .zoom-level {
            text-align: center;
            font-size: 12px;
            font-weight: bold;
            color: #667eea;
            padding: 5px 0;
        }

        .view-toggle {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üå≥ XML Tree Visualization: {{ filename }}</h1>
        <div class="header-actions">
            <button class="btn view-toggle" onclick="toggleView()" id="viewToggleBtn">üìä Switch to Interactive Tree</button>
            <a href="/" class="btn">‚Üê Back to Upload</a>
        </div>
    </div>

    <div class="stats-bar">
        <div class="stat-item">
            <div class="stat-value">{{ stats.total_elements }}</div>
            <div class="stat-label">Total Elements</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">{{ stats.max_depth }}</div>
            <div class="stat-label">Tree Depth</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">{{ stats.unique_tags }}</div>
            <div class="stat-label">Unique Tags</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">{{ stats.text_elements }}</div>
            <div class="stat-label">Text Elements</div>
        </div>
    </div>

    <!-- Image View (Default) -->
    <div class="main-container" id="imageView" style="display: flex;">
        <div class="image-container">
            <div class="zoom-controls">
                <button class="zoom-btn" onclick="zoomIn()" title="Zoom In">+</button>
                <div class="zoom-level" id="zoomLevel">100%</div>
                <button class="zoom-btn" onclick="zoomOut()" title="Zoom Out">‚àí</button>
                <button class="zoom-btn" onclick="zoomReset()" title="Reset Zoom" style="font-size: 16px;">‚ü≤</button>
            </div>
            <div class="image-wrapper" id="imageWrapper">
                <img id="treeImage" class="tree-image" src="{{ image_path }}?t={{ timestamp }}" alt="XML Tree Visualization" onload="console.log('Image loaded:', this.src)" onerror="console.error('Failed to load image:', this.src)" />
            </div>
        </div>
    </div>

    <!-- Interactive Tree View -->
    <div class="main-container" id="treeView" style="display: none; flex-direction: column;">
        <div class="controls">
            <button onclick="expandAll()">‚¨áÔ∏è Expand All</button>
            <button onclick="collapseAll()">‚¨ÜÔ∏è Collapse All</button>
            <button onclick="expandLevel(1)">Expand Level 1</button>
            <button onclick="expandLevel(2)">Expand Level 2</button>
        </div>
        <div class="tree-container" id="treeContainer" style="flex: 1; overflow-y: auto; overflow-x: auto;">
            <div id="treeContent">
                <!-- Tree will be rendered here -->
            </div>
        </div>
    </div>

    <script>
        const treeData = {{ tree_structure|safe }};
        let currentView = 'image'; // 'image' or 'tree'
        let currentZoom = 1;
        let isDragging = false;
        let startX, startY, scrollLeft, scrollTop;

        // View Toggle
        function toggleView() {
            const imageView = document.getElementById('imageView');
            const treeView = document.getElementById('treeView');
            const toggleBtn = document.getElementById('viewToggleBtn');
            
            if (currentView === 'image') {
                imageView.style.display = 'none';
                treeView.style.display = 'flex';
                toggleBtn.textContent = 'üñºÔ∏è Switch to Image View';
                currentView = 'tree';
                
                // Render tree if not already rendered
                if (treeData && document.getElementById('treeContent').innerHTML === '') {
                    document.getElementById('treeContent').innerHTML = renderTreeNode(treeData);
                }
            } else {
                imageView.style.display = 'flex';
                treeView.style.display = 'none';
                toggleBtn.textContent = 'üìä Switch to Interactive Tree';
                currentView = 'image';
            }
        }

        // Zoom Functions
        function updateZoom(newZoom) {
            currentZoom = Math.max(0.25, Math.min(5, newZoom));
            const treeImage = document.getElementById('treeImage');
            treeImage.style.transform = `scale(${currentZoom})`;
            document.getElementById('zoomLevel').textContent = Math.round(currentZoom * 100) + '%';
        }

        function zoomIn() {
            updateZoom(currentZoom + 0.25);
        }

        function zoomOut() {
            updateZoom(currentZoom - 0.25);
        }

        function zoomReset() {
            updateZoom(1);
            const imageWrapper = document.getElementById('imageWrapper');
            imageWrapper.scrollTop = 0;
            imageWrapper.scrollLeft = 0;
        }

        // Mouse wheel zoom - DISABLED (only use + and - buttons)
        // Removed mouse wheel zoom functionality

        // Pan/Drag functionality
        const imageWrapper = document.getElementById('imageWrapper');
        imageWrapper.addEventListener('mousedown', (e) => {
            isDragging = true;
            startX = e.pageX - imageWrapper.offsetLeft;
            startY = e.pageY - imageWrapper.offsetTop;
            scrollLeft = imageWrapper.scrollLeft;
            scrollTop = imageWrapper.scrollTop;
        });

        imageWrapper.addEventListener('mouseleave', () => {
            isDragging = false;
        });

        imageWrapper.addEventListener('mouseup', () => {
            isDragging = false;
        });

        imageWrapper.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            e.preventDefault();
            const x = e.pageX - imageWrapper.offsetLeft;
            const y = e.pageY - imageWrapper.offsetTop;
            const walkX = (x - startX) * 2;
            const walkY = (y - startY) * 2;
            imageWrapper.scrollLeft = scrollLeft - walkX;
            imageWrapper.scrollTop = scrollTop - walkY;
        });
        
        function renderTreeNode(node, level = 0) {
            const hasChildren = node.children && node.children.length > 0;
            const nodeId = node.id || 1;
            
            // Build data section (hidden by default - only shown when expanded)
            const attrs = node.attributes || {};
            const attrKeys = Object.keys(attrs);
            let dataHtml = '';
            
            // Only create data section if there's data to show
            if (attrKeys.length > 0 || node.text) {
                dataHtml = '<div class="tree-node-data">';
                
                if (attrKeys.length > 0) {
                    dataHtml += '<div class="data-item"><span class="data-label">Attributes:</span>';
                    attrKeys.forEach(key => {
                        let value = attrs[key];
                        // Truncate very long values
                        if (value && value.length > 100) {
                            value = value.substring(0, 100) + '...';
                        }
                        dataHtml += `<div style="margin-left: 20px; margin-top: 5px;"><strong>${key}:</strong> ${value || '(empty)'}</div>`;
                    });
                    dataHtml += '</div>';
                }
                
                if (node.text) {
                    dataHtml += `<div class="data-item"><span class="data-label">Text:</span> ${node.text}</div>`;
                }
                
                dataHtml += '</div>';
            }
            
            // Node header - always visible, shows number and tag
            let html = `
                <div class="tree-node" data-level="${level}" data-node-id="${nodeId}">
                    <div class="tree-node-header" onclick="toggleNode(this)">
                        <span class="tree-toggle">${hasChildren ? '‚ñ∂' : '¬∑'}</span>
                        <span class="tree-node-number">${nodeId}</span>
                        <span class="tree-node-tag">&lt;${node.tag}&gt;</span>
                    </div>
                    ${dataHtml}
            `;
            
            // Add children (collapsed by default)
            if (hasChildren) {
                html += `<div class="tree-node-children">`;
                node.children.forEach(child => {
                    html += renderTreeNode(child, level + 1);
                });
                html += `</div>`;
            }
            
            html += `</div>`;
            return html;
        }

        function toggleNode(header) {
            const node = header.closest('.tree-node');
            const childrenDiv = node.querySelector('.tree-node-children');
            const dataDiv = node.querySelector('.tree-node-data');
            const toggle = header.querySelector('.tree-toggle');
            
            // Toggle data visibility
            if (dataDiv) {
                const isDataExpanded = dataDiv.classList.contains('expanded');
                if (isDataExpanded) {
                    dataDiv.classList.remove('expanded');
                    header.classList.remove('expanded');
                } else {
                    dataDiv.classList.add('expanded');
                    header.classList.add('expanded');
                }
            }
            
            // Toggle children visibility
            if (childrenDiv) {
                const isChildrenExpanded = childrenDiv.classList.contains('expanded');
                if (isChildrenExpanded) {
                    childrenDiv.classList.remove('expanded');
                    toggle.textContent = '‚ñ∂';
                } else {
                    childrenDiv.classList.add('expanded');
                    toggle.textContent = '‚ñº';
                }
            }
        }

        function expandAll() {
            // Expand all children
            document.querySelectorAll('.tree-node-children').forEach(el => {
                el.classList.add('expanded');
            });
            // Expand all data
            document.querySelectorAll('.tree-node-data').forEach(el => {
                el.classList.add('expanded');
            });
            // Update headers
            document.querySelectorAll('.tree-node-header').forEach(el => {
                el.classList.add('expanded');
            });
            // Update toggle icons
            document.querySelectorAll('.tree-toggle').forEach(el => {
                if (el.textContent === '‚ñ∂') {
                    el.textContent = '‚ñº';
                }
            });
        }

        function collapseAll() {
            // Collapse all children
            document.querySelectorAll('.tree-node-children').forEach(el => {
                el.classList.remove('expanded');
            });
            // Collapse all data
            document.querySelectorAll('.tree-node-data').forEach(el => {
                el.classList.remove('expanded');
            });
            // Update headers
            document.querySelectorAll('.tree-node-header').forEach(el => {
                el.classList.remove('expanded');
            });
            // Update toggle icons
            document.querySelectorAll('.tree-toggle').forEach(el => {
                if (el.textContent === '‚ñº') {
                    el.textContent = '‚ñ∂';
                }
            });
        }

        function expandLevel(level) {
            document.querySelectorAll('.tree-node').forEach(node => {
                const nodeLevel = parseInt(node.getAttribute('data-level'));
                if (nodeLevel < level) {
                    const childrenDiv = node.querySelector('.tree-node-children');
                    const dataDiv = node.querySelector('.tree-node-data');
                    const header = node.querySelector('.tree-node-header');
                    const toggle = header.querySelector('.tree-toggle');
                    
                    if (childrenDiv) {
                        childrenDiv.classList.add('expanded');
                        header.classList.add('expanded');
                        toggle.textContent = '‚ñº';
                    }
                    if (dataDiv) {
                        dataDiv.classList.add('expanded');
                    }
                }
            });
        }

        // Image load handling
        document.getElementById('treeImage').addEventListener('load', function() {
            console.log('‚úÖ Tree image loaded successfully');
            console.log('   Image path:', this.src);
            console.log('   Natural size:', this.naturalWidth, 'x', this.naturalHeight);
        });

        document.getElementById('treeImage').addEventListener('error', function() {
            console.error('‚ùå Failed to load tree image');
            console.error('   Image path:', this.src);
            const imageWrapper = document.getElementById('imageWrapper');
            imageWrapper.innerHTML = `
                <div style="text-align: center; padding: 50px; color: #c62828;">
                    <div style="font-size: 3em; margin-bottom: 20px;">‚ö†Ô∏è</div>
                    <div style="font-size: 1.2em; margin-bottom: 10px;">Failed to load tree visualization image</div>
                    <div style="font-size: 0.9em; color: #666;">Please try uploading the file again</div>
                    <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        Reload Page
                    </button>
                </div>
            `;
        });

        // Render tree on page load (for interactive view)
        document.addEventListener('DOMContentLoaded', function() {
            // Image view is shown by default, tree will be rendered when switching views
            console.log('Page loaded. Image view is default.');
        });
    </script>
</body>
</html>

